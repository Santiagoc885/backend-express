<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Usuarios</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">
        <h1> Gestor de Usuarios</h1>

        <div class="nav-buttons">
            <button class="nav-btn active" onclick="showView('view')"> Ver Usuarios</button>
            <button class="nav-btn" onclick="showView('manage')"> Gestionar Usuarios</button>
        </div>

        <!-- VISTA: Ver Usuarios -->
        <div id="view" class="view-section">
            <div class="users-section">
                <h2> Todos los Usuarios</h2>
                <button class="refresh-btn" id="refreshBtnView"> Actualizar Lista</button>
                <div class="loading" id="usersLoadingView"> Cargando usuarios...</div>
                <div class="user-list" id="usersListView">
                    <div class="empty-state">No hay usuarios aún.</div>
                </div>
            </div>
        </div>

        <!-- VISTA: Gestionar Usuarios -->
        <div id="manage" class="view-section" style="display: none;">
            <div class="main-grid">
                <!-- Card Crear Usuario -->
                <div class="card">
                    <h2> Crear Usuario</h2>
                    <form id="createUserForm">
                        <div class="form-group">
                            <label for="name">Nombre:</label>
                            <input type="text" id="name" name="name" required placeholder="Ej: Santiago">
                        </div>
                        <div class="form-group">
                            <label for="email">Email:</label>
                            <input type="email" id="email" name="email" required placeholder="Ej: santiago@test.com">
                        </div>
                        <div class="loading" id="createLoading"> Creando usuario...</div>
                        <button type="submit">Crear Usuario</button>
                        <div class="message" id="createMessage"></div>
                    </form>
                </div>

                <!-- Card Buscar Usuario -->
                <div class="card">
                    <h2> Buscar Usuario por ID</h2>
                    <form id="searchUserForm">
                        <div class="form-group">
                            <label for="userId">ID del Usuario:</label>
                            <input type="text" id="userId" name="userId" required placeholder="Ej: 65a123b456c789d012e34f56">
                        </div>
                        <div class="loading" id="searchLoading"> Buscando usuario...</div>
                        <button type="submit">Buscar</button>
                        <div class="message" id="searchMessage"></div>
                    </form>
                    <div id="searchResult" style="margin-top: 20px;"></div>
                </div>
            </div>

            <!-- Sección de Usuarios -->
            <div class="users-section">
                <h2> Listado de Usuarios</h2>
                <button class="refresh-btn" id="refreshBtnManage"> Actualizar Lista</button>
                <div class="loading" id="usersLoadingManage"> Cargando usuarios...</div>
                <div class="user-list" id="usersListManage">
                    <div class="empty-state">No hay usuarios aún. ¡Crea uno para empezar!</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin + '/api';

        // Cambiar entre vistas
        function showView(viewName) {
            // Ocultar todas las vistas
            document.querySelectorAll('.view-section').forEach(view => {
                view.style.display = 'none';
            });

            // Mostrar la vista seleccionada
            document.getElementById(viewName).style.display = 'block';

            // Actualizar botones activos
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Cargar usuarios cuando abra la vista
            if (viewName === 'view') {
                loadUsersView();
            } else {
                loadUsersManage();
            }
        }

        // ========== VISTA: Ver Usuarios ==========
        async function loadUsersView() {
            const loading = document.getElementById('usersLoadingView');
            const usersList = document.getElementById('usersListView');

            loading.classList.add('show');

            try {
                const response = await fetch(`${API_URL}/users`);
                const users = await response.json();

                if (users.length > 0) {
                    usersList.innerHTML = users.map(user => `
                        <div class="user-card">
                            <div class="user-info">
                                <div class="user-name">${user.name}</div>
                                <div class="user-email">${user.email}</div>
                                <div class="user-id">ID: ${user._id}</div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    usersList.innerHTML = '<div class="empty-state">No hay usuarios aún.</div>';
                }
            } catch (error) {
                usersList.innerHTML = `<div class="empty-state"> Error al cargar usuarios: ${error.message}</div>`;
            } finally {
                loading.classList.remove('show');
            }
        }

        document.getElementById('refreshBtnView').addEventListener('click', loadUsersView);

        // ========== VISTA: Gestionar Usuarios ==========
        
        // Crear Usuario
        document.getElementById('createUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const loading = document.getElementById('createLoading');
            const message = document.getElementById('createMessage');

            loading.classList.add('show');
            message.classList.remove('show');

            try {
                const response = await fetch(`${API_URL}/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: document.getElementById('name').value,
                        email: document.getElementById('email').value
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    message.textContent = ' Usuario creado exitosamente';
                    message.classList.add('show', 'success');
                    document.getElementById('createUserForm').reset();
                    loadUsersManage();
                } else {
                    message.textContent =  + (data.message || 'Error al crear usuario');
                    message.classList.add('show', 'error');
                }
            } catch (error) {
                message.textContent = ' Error de conexión: ' + error.message;
                message.classList.add('show', 'error');
            } finally {
                loading.classList.remove('show');
            }
        });

        // Buscar Usuario por ID
        document.getElementById('searchUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const loading = document.getElementById('searchLoading');
            const message = document.getElementById('searchMessage');
            const result = document.getElementById('searchResult');

            loading.classList.add('show');
            message.classList.remove('show');
            result.innerHTML = '';

            try {
                const userId = document.getElementById('userId').value;
                const response = await fetch(`${API_URL}/users/${userId}`);
                const data = await response.json();

                if (response.ok) {
                    message.textContent = ' Usuario encontrado';
                    message.classList.add('show', 'success');
                    result.innerHTML = `
                        <div class="user-card">
                            <div class="user-info">
                                <div class="user-name">${data.name}</div>
                                <div class="user-email">${data.email}</div>
                                <div class="user-id">ID: ${data._id}</div>
                            </div>
                        </div>
                    `;
                } else {
                    message.textContent =  + (data.message || 'Usuario no encontrado');
                    message.classList.add('show', 'error');
                }
            } catch (error) {
                message.textContent = ' Error de conexión: ' + error.message;
                message.classList.add('show', 'error');
            } finally {
                loading.classList.remove('show');
            }
        });

        // Cargar usuarios en vista Gestionar
        async function loadUsersManage() {
            const loading = document.getElementById('usersLoadingManage');
            const usersList = document.getElementById('usersListManage');

            loading.classList.add('show');

            try {
                const response = await fetch(`${API_URL}/users`);
                const users = await response.json();

                if (users.length > 0) {
                    usersList.innerHTML = users.map(user => `
                        <div class="user-card">
                            <div class="user-info">
                                <div class="user-name">${user.name}</div>
                                <div class="user-email">${user.email}</div>
                                <div class="user-id">ID: ${user._id}</div>
                            </div>
                            <div class="user-actions">
                                <button class="btn-delete" onclick="deleteUser('${user._id}')"> Eliminar</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    usersList.innerHTML = '<div class="empty-state">No hay usuarios aún. ¡Crea uno para empezar!</div>';
                }
            } catch (error) {
                usersList.innerHTML = `<div class="empty-state">❌ Error al cargar usuarios: ${error.message}</div>`;
            } finally {
                loading.classList.remove('show');
            }
        }

        // Eliminar usuario
        async function deleteUser(userId) {
            if (!confirm('¿Estás seguro de que deseas eliminar este usuario?')) return;

            try {
                const response = await fetch(`${API_URL}/users/${userId}`, { method: 'DELETE' });
                const data = await response.json();

                if (response.ok) {
                    alert('✅ Usuario eliminado');
                    loadUsersManage();
                } else {
                    alert('❌ Error: ' + (data.message || 'No se pudo eliminar'));
                }
            } catch (error) {
                alert('❌ Error de conexión: ' + error.message);
            }
        }

        document.getElementById('refreshBtnManage').addEventListener('click', loadUsersManage);

        // Cargar usuarios al iniciar
        loadUsersView();
    </script>
</body>
</html>
